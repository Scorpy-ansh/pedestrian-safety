<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pedestrian Safety & Safe Route</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <!-- ⬅️ Minecraft-style webfont -->
  <link href="https://fonts.cdnfonts.com/css/minecraft-4" rel="stylesheet" />
  <style>
    
    html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
    .panel {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #ffffff;
  padding: 16px;
  border-radius: 16px;
  box-shadow: 0 4px 18px rgb(0, 0, 0);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  max-width: 380px;
  border: 1px solid #e6e6e6;
}

.row { margin: 10px 0; }

label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 13px;
  color: #444;
}

select, input {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #dcdcdc;
  border-radius: 10px;
  background: #fafafa;
  font-size: 14px;
  box-sizing: border-box;
}

select:focus, input:focus {
  outline: none;
  border-color: #9abfe0;
  background: #fff;
}

.btn {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  background: #e8f0fe;
  color: #1a3d7c;
  font-weight: 600;
  transition: all 0.2s ease;
}

.btn:hover {
  background: #d2e3fc;
}

.btn.primary {
  background: #a8d5ba;
  color: #084c25;
}

.btn.primary:hover {
  background: #92cfa8;
}

.hint {
  font-size: 12px;
  color: #667085;
  margin-top: 6px;
  font-style: italic;
}

    #legend {
      position:absolute; bottom:18px; left:10px; background:#fff; padding:10px 12px;
      border-radius:10px; font-size:12px; box-shadow:0 2px 8px rgba(0,0,0,.2);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .chip { display:inline-block; width:14px; height:14px; border-radius:3px; margin-right:6px; vertical-align:middle; }
    #toast {
      position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,.8); color:#fff;
      padding:8px 12px; border-radius:8px; font-size:12px; display:none;
    }
    /* Legend layout fix */
#legend { min-width: 160px; }
.legend-title { font-weight: 700; margin-bottom: 6px; }
.legend-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 2px 0;
  line-height: 1.2;
}
.legend-swatch {
  width: 14px;
  height: 14px;
  border-radius: 3px;
  flex: 0 0 14px;
  border: 1px solid rgba(0,0,0,.15);
}
.brand-banner {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: inline-flex;
  align-items: center;
  gap: 14px;                 /* ⬅️ more spacing between title and chips */
  padding: 14px 22px;        /* ⬅️ bigger padding (box size) */
  border-radius: 22px;       /* ⬅️ bigger rounding */
  background: linear-gradient(135deg, #f3f7ff, #eaf7f1);
  border: 1px solid #e6ebf5;
  box-shadow: 0 8px 20px rgba(0,0,0,.12);
}

.brand-title {
  font-family: 'Minecraft', monospace;
  font-size: 22px;           /* ⬅️ bigger text */
  letter-spacing: 1px;       /* ⬅️ more spacing between letters */
  color: #27364a;
  text-shadow: 0 1px 0 #ffffff;
  white-space: nowrap;
}

.brand-chip {
  width: 14px;               /* ⬅️ slightly bigger color chips */
  height: 14px;
  border-radius: 4px;
  border: 1px solid rgba(0,0,0,.12);
}
.chip-risky   { background:#8b0000; }
.chip-risky2  { background:#ff6b6b; }
.chip-mid     { background:#ffd166; }
.chip-safe    { background:#8bd17c; }
.chip-safe2   { background:#2ecc71; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- ⬅️ Project heading badge -->
<div class="brand-banner">
  <span class="brand-title">Pedestrian Safety Score & Safe Route</span>
  <span class="brand-chip chip-risky"></span>
  <span class="brand-chip chip-risky2"></span>
  <span class="brand-chip chip-mid"></span>
  <span class="brand-chip chip-safe"></span>
  <span class="brand-chip chip-safe2"></span>
</div>

<div class="panel">
  <div class="row">
    <label for="place">City / Place (India)</label>
    <select id="place">
      <!-- Major metros -->
      <option value="Bengaluru, India" selected>Bengaluru (Karnataka)</option>
      <option value="Mumbai, India">Mumbai (Maharashtra)</option>
      <option value="Delhi, India">Delhi (NCT)</option>
      <option value="Chennai, India">Chennai (Tamil Nadu)</option>
      <option value="Kolkata, India">Kolkata (West Bengal)</option>
      <option value="Hyderabad, India">Hyderabad (Telangana)</option>
      <option value="Pune, India">Pune (Maharashtra)</option>
      <option value="Ahmedabad, India">Ahmedabad (Gujarat)</option>
      <option value="Jaipur, India">Jaipur (Rajasthan)</option>
      <option value="Lucknow, India">Lucknow (Uttar Pradesh)</option>

      <!-- State/UT capitals (to cover all states fast; states themselves are too large/slow) -->
      <option value="Amaravati, Andhra Pradesh">Amaravati (Andhra Pradesh)</option>
      <option value="Itanagar, Arunachal Pradesh">Itanagar (Arunachal Pradesh)</option>
      <option value="Dispur, Assam">Dispur (Assam)</option>
      <option value="Patna, Bihar">Patna (Bihar)</option>
      <option value="Raipur, Chhattisgarh">Raipur (Chhattisgarh)</option>
      <option value="Panaji, Goa">Panaji (Goa)</option>
      <option value="Gandhinagar, Gujarat">Gandhinagar (Gujarat)</option>
      <option value="Shimla, Himachal Pradesh">Shimla (Himachal Pradesh)</option>
      <option value="Ranchi, Jharkhand">Ranchi (Jharkhand)</option>
      <option value="Bengaluru, Karnataka">Bengaluru (Karnataka)</option>
      <option value="Thiruvananthapuram, Kerala">Thiruvananthapuram (Kerala)</option>
      <option value="Bhopal, Madhya Pradesh">Bhopal (Madhya Pradesh)</option>
      <option value="Mumbai, Maharashtra">Mumbai (Maharashtra)</option>
      <option value="Imphal, Manipur">Imphal (Manipur)</option>
      <option value="Shillong, Meghalaya">Shillong (Meghalaya)</option>
      <option value="Aizawl, Mizoram">Aizawl (Mizoram)</option>
      <option value="Kohima, Nagaland">Kohima (Nagaland)</option>
      <option value="Bhubaneswar, Odisha">Bhubaneswar (Odisha)</option>
      <option value="Jaipur, Rajasthan">Jaipur (Rajasthan)</option>
      <option value="Gangtok, Sikkim">Gangtok (Sikkim)</option>
      <option value="Chennai, Tamil Nadu">Chennai (Tamil Nadu)</option>
      <option value="Hyderabad, Telangana">Hyderabad (Telangana)</option>
      <option value="Agartala, Tripura">Agartala (Tripura)</option>
      <option value="Lucknow, Uttar Pradesh">Lucknow (Uttar Pradesh)</option>
      <option value="Dehradun, Uttarakhand">Dehradun (Uttarakhand)</option>
      <option value="Kolkata, West Bengal">Kolkata (West Bengal)</option>

      <!-- Union Territories -->
      <option value="Chandigarh, India">Chandigarh (Chandigarh UT)</option>
      <option value="Daman, India">Daman (Dadra & Nagar Haveli and Daman & Diu)</option>
      <option value="Kavaratti, India">Kavaratti (Lakshadweep)</option>
      <option value="Puducherry, India">Puducherry (Puducherry)</option>
      <option value="Srinagar, India">Srinagar (J&K summer)</option>
      <option value="Jammu, India">Jammu (J&K winter)</option>
      <option value="Leh, India">Leh (Ladakh)</option>
      <option value="Port Blair, India">Port Blair (Andaman & Nicobar)</option>
      <option value="New Delhi, India">New Delhi (NCT of Delhi)</option>
      <!-- add more cities anytime: just append <option value="City, State">Label</option> -->
    </select>
  </div>

  <div class="row" style="display:flex; gap:10px;">
    <div style="flex:1;">
      <label>Start (lat, lon)</label>
      <input id="sLat" placeholder="lat" value="12.9716"/>
    </div>
    <div style="flex:1;">
      <label style="opacity:0;">•</label>
      <input id="sLon" placeholder="lon" value="77.5946"/>
    </div>
  </div>

  <div class="row" style="display:flex; gap:10px;">
    <div style="flex:1;">
      <label>End (lat, lon)</label>
      <input id="eLat" placeholder="lat" value="12.9850"/>
    </div>
    <div style="flex:1;">
      <label style="opacity:0;">•</label>
      <input id="eLon" placeholder="lon" value="77.6050"/>
    </div>
  </div>

  <div class="row">
    <button id="load" class="btn">Load city</button>
    <button id="route" class="btn primary">Route</button>
    <button id="reset" class="btn">Reset points</button>
  </div>
  <div class="hint">Tip: click the map — first click sets <b>start</b> (green), second click sets <b>end</b> (blue).</div>
</div>

<div id="legend">
    <div class="legend-title">Safety Score</div>
    <div class="legend-row"><span class="legend-swatch" style="background:#8b0000"></span><span>Very risky</span></div>
    <div class="legend-row"><span class="legend-swatch" style="background:#ff6b6b"></span><span>Risky</span></div>
    <div class="legend-row"><span class="legend-swatch" style="background:#ffd166"></span><span>Moderate</span></div>
    <div class="legend-row"><span class="legend-swatch" style="background:#8bd17c"></span><span>Safer</span></div>
    <div class="legend-row"><span class="legend-swatch" style="background:#2ecc71"></span><span>Very safe</span></div>
  </div>
  

<div id="toast"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script>
  // (your JS remains exactly the same)
  // --- helpers ---
  const toastEl = document.getElementById('toast');
  function toast(msg, ok=true) {
    toastEl.textContent = msg;
    toastEl.style.background = ok ? 'rgba(0,0,0,.85)' : '#c62828';
    toastEl.style.display = 'block';
    setTimeout(()=> toastEl.style.display='none', 1800);
  }
  async function postJSON(url, data) {
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // --- map init: minimal style + OSM raster ---
  const map = new maplibregl.Map({
    container: 'map',
    style: { version: 8, sources: {}, layers: [] },
    center: [77.5946, 12.9716], // lon, lat
    zoom: 12
  });

  let startMarker = null, endMarker = null, cityMarker = null;

  map.on('load', () => {
    map.addSource('osm', {
      type: 'raster',
      tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
      tileSize: 256,
      attribution: '© OpenStreetMap contributors'
    });
    map.addLayer({ id:'osm-layer', type:'raster', source:'osm' });

    // initial city marker (Bengaluru)
    cityMarker = new maplibregl.Marker({ color: "red" })
      .setLngLat([77.5946, 12.9716])
      .addTo(map);
  });

  // Click-to-set points: 1st click = start (green), 2nd = end (blue)
  map.on('click', e => {
    if (!startMarker) {
      startMarker = new maplibregl.Marker({color:"green"}).setLngLat(e.lngLat).addTo(map);
      document.getElementById('sLat').value = e.lngLat.lat.toFixed(6);
      document.getElementById('sLon').value = e.lngLat.lng.toFixed(6);
      toast('Start set (green)');
    } else if (!endMarker) {
      endMarker = new maplibregl.Marker({color:"blue"}).setLngLat(e.lngLat).addTo(map);
      document.getElementById('eLat').value = e.lngLat.lat.toFixed(6);
      document.getElementById('eLon').value = e.lngLat.lng.toFixed(6);
      toast('End set (blue)');
    }
  });

  // Reset points
  document.getElementById('reset').onclick = () => {
    if (startMarker) { startMarker.remove(); startMarker = null; }
    if (endMarker) { endMarker.remove(); endMarker = null; }
    document.getElementById('sLat').value = '';
    document.getElementById('sLon').value = '';
    document.getElementById('eLat').value = '';
    document.getElementById('eLon').value = '';
    if (map.getLayer('route-line')) map.removeLayer('route-line');
    if (map.getSource('route-src')) map.removeSource('route-src');
    toast('Points reset');
  };

  // Load city -> (1) build graph, (2) fly to city, (3) draw safety-colored edges
  document.getElementById('load').onclick = async () => {
    try {
      const place = document.getElementById('place').value;
      toast('Building graph…');
      await postJSON('/graph', { place, alpha: 0.5 });

      // --- fly to selected city and move the red marker ---
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}&limit=1`;
      const geo = await fetch(url, { headers: { 'Accept-Language': 'en' } }).then(r=>r.json());
      if (geo && geo[0]) {
        const lat = parseFloat(geo[0].lat), lon = parseFloat(geo[0].lon);
        map.flyTo({ center: [lon, lat], zoom: 12, speed: 0.8 });
        if (!cityMarker) {
          cityMarker = new maplibregl.Marker({ color: "red" }).setLngLat([lon, lat]).addTo(map);
        } else {
          cityMarker.setLngLat([lon, lat]);
        }
      }

      const edges = await fetch('/edges.geojson').then(r => r.json());

      // remove old layers if present
      if (map.getLayer('edges-line')) map.removeLayer('edges-line');
      if (map.getSource('edges-src')) map.removeSource('edges-src');

      map.addSource('edges-src', { type: 'geojson', data: edges });
      map.addLayer({
        id: 'edges-line',
        type: 'line',
        source: 'edges-src',
        paint: {
          'line-width': 2,
          'line-color': [
            'interpolate', ['linear'], ['get','safety_score'],
            0,   '#8b0000',  /* very risky */
            40,  '#ff6b6b',
            60,  '#ffd166',
            75,  '#8bd17c',
            90,  '#2ecc71'   /* very safe */
          ],
          'line-opacity': 0.9
        }
      });

      // fit to edges if present
      if (edges && edges.features && edges.features.length > 0) {
        const bbox = turf.bbox(edges);
        map.fitBounds(bbox, { padding: 40 });
      }

      toast('City loaded ✓');
    } catch (err) {
      console.error(err);
      toast('Load failed — check server logs', false);
    }
  };

  // Route button -> compute safest route and draw blue line
  document.getElementById('route').onclick = async () => {
    try {
      const sLat = parseFloat(document.getElementById('sLat').value);
      const sLon = parseFloat(document.getElementById('sLon').value);
      const eLat = parseFloat(document.getElementById('eLat').value);
      const eLon = parseFloat(document.getElementById('eLon').value);
      if ([sLat,sLon,eLat,eLon].some(v => Number.isNaN(v))) {
        toast('Set start & end (click map or fill inputs)', false);
        return;
      }

      const gj = await postJSON('/route', { start:{ lat:sLat, lon:sLon }, end:{ lat:eLat, lon:eLon } });

      if (map.getLayer('route-line')) map.removeLayer('route-line');
      if (map.getSource('route-src')) map.removeSource('route-src');

      map.addSource('route-src', { type:'geojson', data: gj });
      map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route-src',
        paint: { 'line-color':'#0077ff', 'line-width':6, 'line-opacity':0.85 }
      });

      // zoom to the route
      const bbox = turf.bbox(gj);
      map.fitBounds(bbox, { padding: 60 });
      toast('Route drawn ✓');
    } catch (err) {
      console.error(err);
      toast('Routing failed — check server logs', false);
    }
  };
</script>
</body>
</html>
